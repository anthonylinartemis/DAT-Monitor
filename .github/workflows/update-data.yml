name: Update DAT Data

on:
  schedule:
    # Runs at 10am, 2pm, 6pm ET on weekdays
    # UTC times: 15:00, 19:00, 23:00 (EST) or 14:00, 18:00, 22:00 (EDT)
    - cron: '0 15,19,23 * * 1-5'
  workflow_dispatch:  # Allows manual trigger from GitHub UI
    inputs:
      force_update:
        description: 'Force update even if no changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          npx playwright install --with-deps chromium

      - name: Verify SEC_USER_AGENT secret
        run: |
          if [ -z "${{ secrets.SEC_USER_AGENT }}" ]; then
            echo "::error::SEC_USER_AGENT secret is not set!"
            echo "Please add it in Settings > Secrets > Actions"
            exit 1
          fi
          echo "SEC_USER_AGENT is configured"

      - name: Run scraper
        id: scraper
        env:
          SEC_USER_AGENT: ${{ secrets.SEC_USER_AGENT }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Starting DAT Treasury Monitor scraper..."
          echo "Current time: $(date)"
          echo ""
          python scripts/scraper.py 2>&1 | tee scraper_output.txt

          # Check if changes were detected
          if grep -q "CHANGES DETECTED" scraper_output.txt; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Show scraper output
        run: |
          echo "=== Scraper Output ==="
          cat scraper_output.txt

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            Auto-update DAT holdings data

            Updated: ${{ steps.scraper.outputs.changes_detected == 'true' && 'Changes detected' || 'Timestamp only' }}
          file_pattern: "data.json"
          commit_author: "DAT Monitor Bot <bot@dat-monitor.com>"

      - name: Send Slack notification
        if: steps.scraper.outputs.changes_detected == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Extract change details from scraper output
          CHANGES=$(grep -A 20 "CHANGES DETECTED" scraper_output.txt | grep "  " | head -10 || echo "See GitHub Actions for details")

          # Escape special characters for JSON using Python
          CHANGES_ESCAPED=$(echo "$CHANGES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          # Remove outer quotes added by json.dumps
          CHANGES_ESCAPED=${CHANGES_ESCAPED:1:-1}

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸ“Š DAT Holdings Update Detected\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Changes detected in treasury holdings:*\n\`\`\`${CHANGES_ESCAPED}\`\`\`\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Time:*\n$(date '+%Y-%m-%d %H:%M UTC')\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*View:*\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>\"
                    }
                  ]
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL"

      - name: Run data quality check
        id: quality
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Running data quality check..."
          python scripts/data_quality.py --alert-new 2>&1 | tee quality_output.txt || true

      - name: Summary
        run: |
          echo "## DAT Treasury Monitor Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.scraper.outputs.changes_detected }}" == "true" ]; then
            echo "**Status:** Changes detected and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scraper Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 scraper_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Quality Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 quality_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Weekly data quality digest - runs Monday 9am ET
  weekly-digest:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Check if Monday 9am run
        id: check_day
        run: |
          # Only run weekly digest on Monday at ~15:00 UTC (10am ET)
          DAY=$(date -u +%u)
          HOUR=$(date -u +%H)
          if [ "$DAY" == "1" ] && [ "$HOUR" == "15" ]; then
            echo "is_monday_morning=true" >> $GITHUB_OUTPUT
          else
            echo "is_monday_morning=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check_day.outputs.is_monday_morning == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check_day.outputs.is_monday_morning == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        if: steps.check_day.outputs.is_monday_morning == 'true'
        run: |
          pip install --upgrade pip
          pip install requests

      - name: Send weekly digest
        if: steps.check_day.outputs.is_monday_morning == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python scripts/data_quality.py --daily-digest
