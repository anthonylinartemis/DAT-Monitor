================================================================================
                    DAT MONITOR V3 OVERHAUL - SESSION DOCUMENTATION
                              January 28, 2026 (Version 2)
================================================================================

TABLE OF CONTENTS
-----------------
1. Executive Summary
2. Changes by Phase
3. Code Quality Review & Fixes
4. Developer Etiquette Guide
5. Testing Strategy (Fortune 500 Standards)
6. Multi-Agent Code Review Process
7. Files Modified Summary
8. Verification Checklist
9. Session Continuation - GitHub Backup & Live Dashboard Links
10. Filing Feed, IR Scraper & Price API Enhancements (NEW)
11. Code Simplification Pass (NEW)

================================================================================
1. EXECUTIVE SUMMARY
================================================================================

This session implemented a major overhaul of the DAT Monitor application,
covering treasury data export, new dashboard scrapers, stock price API
integration, Metaplanet USD price fixes, and comprehensive metrics calculation
improvements.

Key Accomplishments:
- Added holdingsKeywords to all token configurations
- Extended StrategyTrackerCompany with shares outstanding fields
- Implemented Treasury Copy for IDE with selective row export
- Enhanced update banner with form pre-fill functionality
- Added BNC (CEA Industries) and DFDV scrapers
- Integrated stock price API with Artemis fallback
- Fixed Metaplanet JPY to USD conversion
- Enhanced mNAV calculation with priority-based logic
- Fixed 8 code quality issues identified by health check
- NEW: Filing Feed view with AI summaries
- NEW: IR page scraper for press release discovery
- NEW: Yahoo Finance stock price integration
- NEW: Chart timeframe and data display fixes

================================================================================
2. CHANGES BY PHASE
================================================================================

------------------------------------------------------------------------------
PHASE 1: DATA MODEL & KEYWORDS
------------------------------------------------------------------------------

FILE: /data.json

WHAT WAS CHANGED:
Added `holdingsKeywords` array to each token configuration in the tokenConfig
object. These keywords are used by scrapers to identify token holdings in
dashboard text.

BEFORE:
```json
"SOL": {
  "name": "Solana",
  "minHoldings": 100,
  "maxHoldings": 100000000,
  "keywords": ["solana", "sol"]
}
```

AFTER:
```json
"SOL": {
  "name": "Solana",
  "minHoldings": 100,
  "maxHoldings": 100000000,
  "keywords": ["solana", "sol"],
  "holdingsKeywords": [
    "SOL Count",
    "SOL Holdings",
    "Total SOL",
    "Solana Holdings"
  ]
}
```

WHY THIS MATTERS:
- Provides token-specific keywords for dashboard scraping
- Allows scrapers to identify holdings values in varied text formats
- Supports multi-token companies with different display conventions
- Improves accuracy of automated data extraction

TOKENS UPDATED: BTC, ETH, SOL, HYPE, BNB

ADDITIONAL FIX:
Fixed a syntax error in data.json - missing comma after "lastSecUpdate" field
on line 179 for the MSTR company entry.

------------------------------------------------------------------------------
PHASE 1.2: EXTEND STRATEGYTRACKER COMPANY WITH SHARES FIELDS
------------------------------------------------------------------------------

FILE: /scraper/website_scrapers.py

WHAT WAS CHANGED:
Renamed fields in StrategyTrackerCompany dataclass to use clearer terminology
for shares outstanding tracking.

BEFORE:
```python
shares_outstanding: Optional[int]
diluted_shares: Optional[int]
```

AFTER:
```python
basic_shares_outstanding: Optional[int]   # Common shares outstanding
fully_diluted_shares: Optional[int]       # Assumed diluted shares outstanding
```

WHY THIS MATTERS:
- Clearer field names distinguish common vs diluted shares
- Supports future functionality for fully diluted mNAV calculations
- Aligns with financial reporting standards terminology
- Makes code self-documenting for financial calculations

FIELD MAPPING UPDATED:
```python
_ST_FIELDS = [
    ("basic_shares_outstanding", "sharesOutstanding"),
    ("fully_diluted_shares", "fullyDilutedShares"),
    ...
]
```

------------------------------------------------------------------------------
PHASE 2: TREASURY COPY FOR IDE WITH ROW SELECTION
------------------------------------------------------------------------------

FILES MODIFIED:
- /js/services/csv.js
- /js/views/company.js
- /css/styles.css

2A. CSV SERVICE ENHANCEMENT
----------------------------

FILE: /js/services/csv.js

NEW FUNCTION ADDED:
```javascript
/**
 * Format selected treasury history entries for IDE copy.
 * @param {Array} treasuryHistory - Full treasury history array
 * @param {Set<string>} selectedDates - Set of selected date strings
 * @returns {string} CSV-formatted string for IDE
 */
export function formatSelectedTreasuryForIDE(treasuryHistory, selectedDates) {
    const header = 'date,num_of_tokens,convertible_debt,...';
    const filtered = treasuryHistory.filter(e => selectedDates.has(e.date));
    const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
    const rows = sorted.map(e => [...].join(','));
    return [header, ...rows].join('\n');
}
```

WHY THIS MATTERS:
- Allows users to copy only selected rows to clipboard
- Maintains data integrity with proper CSV formatting
- Supports IDE-friendly format for quick data entry
- Filters by date selection set for precision

2B. COMPANY VIEW UI ENHANCEMENT
--------------------------------

FILE: /js/views/company.js

HTML CHANGES:
- Added "Copy for IDE" button next to "Export CSV"
- Added checkbox column as first column in treasury table
- Added "Select All" checkbox in table header
- Moved "Copy for IDE" button to be visible in Treasury Metrics section

NEW FUNCTION ADDED:
```javascript
// Module-level state for treasury row selection
let _selectedTreasuryDates = new Set();

function _initTreasurySelection(ticker, company) {
    // Select All checkbox handling
    selectAllCheckbox.addEventListener('change', () => {
        const isChecked = selectAllCheckbox.checked;
        rowCheckboxes.forEach(cb => {
            cb.checked = isChecked;
            // Update row styling and selection state
        });
    });

    // Individual row checkbox handling
    rowCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // Toggle selection state
            // Update select all checkbox indeterminate state
        });
    });

    // Copy for IDE button - copies selected rows (or all if none selected)
    copyIdeBtn.addEventListener('click', (e) => {
        let text;
        if (_selectedTreasuryDates.size > 0) {
            text = formatSelectedTreasuryForIDE(treasuryHistory, _selectedTreasuryDates);
        } else {
            text = formatTreasuryForIDE(treasuryHistory);
        }
        navigator.clipboard.writeText(text);
    });
}
```

WHY THIS MATTERS:
- Users can select specific rows for export
- Supports bulk selection via "Select All"
- Visual feedback with row highlighting
- Graceful fallback to all rows when none selected

2C. CSS STYLING
----------------

FILE: /css/styles.css

NEW STYLES ADDED:
```css
/* Treasury Row Selection */
.treasury-row-selected {
    background: var(--purple-bg) !important;
}
.treasury-row-selected:hover {
    background: var(--purple-bg-hover) !important;
}
.treasury-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--purple);
}
.treasury-checkbox-header {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--purple);
}
.btn-danger {
    background: var(--red-bg);
    color: var(--red);
    border: 1px solid rgba(255, 80, 0, 0.2);
}
```

WHY THIS MATTERS:
- Consistent styling with Artemis Purple theme
- Visual feedback for selected rows
- Accessible checkbox sizing
- Danger button styling for destructive actions

------------------------------------------------------------------------------
PHASE 3: UPDATE BANNER PRE-FILL ENHANCEMENT
------------------------------------------------------------------------------

FILE: /js/views/company.js

WHAT WAS CHANGED:
Enhanced the `_checkForUpdateDelta()` function to automatically pre-fill the
treasury entry form when the update banner shows.

BEFORE:
```javascript
function _checkForUpdateDelta(company, metrics) {
    if (delta > threshold && liveHoldings > latestLocal) {
        banner.style.display = 'flex';
        // No pre-fill functionality
    }
}
```

AFTER:
```javascript
function _checkForUpdateDelta(company, metrics) {
    if (delta > threshold && liveHoldings > latestLocal) {
        banner.style.display = 'flex';
        // Pre-fill the form with live metrics and latest treasury data
        _prefillFormFromMetrics(metrics, latestTreasury);
    }
}
```

NEW HELPER FUNCTION:
```javascript
/**
 * Pre-fill the treasury entry form with live metrics and fallback to latest
 * treasury data.
 * @param {Object} liveMetrics - External metrics from StrategyTracker
 * @param {Object|null} latestTreasury - Most recent treasury_history entry
 */
function _prefillFormFromMetrics(liveMetrics, latestTreasury) {
    // Pre-fill tokens from live holdings
    if (tokensInput && liveMetrics?.btcHoldings) {
        tokensInput.value = Math.round(liveMetrics.btcHoldings);
    }

    // Pre-fill shares outstanding: priority is live metrics > latest treasury
    if (sharesInput) {
        if (liveMetrics?.sharesOutstanding) {
            sharesInput.value = Math.round(liveMetrics.sharesOutstanding);
        } else if (latestTreasury?.num_of_shares) {
            sharesInput.value = latestTreasury.num_of_shares;
        }
    }

    // Pre-fill other fields from latest treasury if available
    const fieldsToPreserve = [
        { inputId: 'entry-conv-debt', field: 'convertible_debt' },
        { inputId: 'entry-conv-shares', field: 'convertible_debt_shares' },
        { inputId: 'entry-non-conv-debt', field: 'non_convertible_debt' },
        { inputId: 'entry-warrants', field: 'warrants' },
        { inputId: 'entry-warrant-shares', field: 'warrant_shares' },
        { inputId: 'entry-cash', field: 'latest_cash' },
    ];
    // ... iterate and pre-fill
}
```

WHY THIS MATTERS:
- Reduces manual data entry when updating treasury
- Prevents user error from copying values manually
- Preserves existing debt/warrant values automatically
- Uses most recent data from live sources

------------------------------------------------------------------------------
PHASE 4: NEW DASHBOARD SCRAPERS (BNC, DFDV)
------------------------------------------------------------------------------

FILE: /scraper/website_scrapers.py

4A. BNC (CEA INDUSTRIES) SCRAPER
---------------------------------

PURPOSE: Scrape BNB holdings from CEA Industries data.js file

NEW DATACLASS:
```python
@dataclass(frozen=True)
class BNCAnalytics:
    """Data extracted from CEA Industries data.js."""
    total_bnb: Optional[int]
    avg_cost_basis: Optional[float]
    mnav: Optional[float]

    def to_json_dict(self) -> dict:
        result: dict = {}
        if self.total_bnb is not None:
            result["totalBnb"] = self.total_bnb
        if self.avg_cost_basis is not None:
            result["avgCostBasis"] = self.avg_cost_basis
        if self.mnav is not None:
            result["mNAV"] = self.mnav
        return result
```

NEW FUNCTIONS:
```python
def _parse_bnc_data(text: str) -> BNCAnalytics:
    """Parse BNC data.js content to extract BNB holdings."""
    # Look for totalHoldings: XXXX pattern
    # Look for avgCostBasis: XX.XX pattern
    # Look for mNAV: X.XX pattern
    ...

def fetch_bnc_updates(data: dict) -> tuple[list[ScrapedUpdate], dict | None]:
    """Fetch BNC (CEA Industries) data from data.js."""
    ...
```

WHY THIS MATTERS:
- Adds automated tracking for BNB treasury company
- Extracts multiple metrics (holdings, cost basis, mNAV)
- Follows existing scraper patterns for consistency

4B. DFDV (DEFI DEVELOPMENT) SCRAPER
------------------------------------

PURPOSE: Scrape SOL holdings from DeFi Development dashboard

NEW DATACLASS:
```python
@dataclass(frozen=True)
class DFDVAnalytics:
    """Data extracted from DeFi Development dashboard."""
    total_sol: Optional[int]
    shares_outstanding: Optional[int]

    def to_json_dict(self) -> dict:
        result: dict = {}
        if self.total_sol is not None:
            result["totalSol"] = self.total_sol
        if self.shares_outstanding is not None:
            result["sharesOutstanding"] = self.shares_outstanding
        return result
```

NEW FUNCTIONS:
```python
def _parse_dfdv_data(text: str) -> DFDVAnalytics:
    """Parse DFDV dashboard HTML to extract SOL holdings and shares."""
    # Look for SOL count patterns: "X,XXX,XXX SOL" or "SOL Count: X,XXX,XXX"
    for pattern in [
        r"([\d,]+)\s*SOL(?:\s|$|<)",
        r"SOL Count[^\d]*([\d,]+)",   # FIXED: was [^\\d]
        r"Total SOL[^\d]*([\d,]+)",   # FIXED: was [^\\d]
    ]:
        ...

    # Look for shares outstanding patterns
    for pattern in [
        r"Shares Outstanding[^\d]*([\d,]+)",  # FIXED: was [^\\d]
        r"Common Shares[^\d]*([\d,]+)",       # FIXED: was [^\\d]
        r"Outstanding[^\d]*([\d,]+)\s*shares",
    ]:
        ...

def fetch_dfdv_updates(data: dict) -> tuple[list[ScrapedUpdate], dict | None]:
    """Fetch DFDV (DeFi Development) data from dashboard."""
    ...
```

WHY THIS MATTERS:
- Adds automated tracking for major SOL treasury company
- Extracts both holdings and shares outstanding
- Enables mNAV calculation for DFDV

4C. INTEGRATION INTO BUILD_WEBSITE_UPDATES
-------------------------------------------

```python
def build_website_updates(data: dict) -> tuple[list[ScrapedUpdate], dict[str, dict]]:
    """Run all website scrapers. Returns (updates, enrichments)."""
    all_updates: list[ScrapedUpdate] = []
    enrichments: dict[str, dict] = {}

    # Metaplanet (existing)
    mtplf_updates, mtplf_analytics = fetch_metaplanet_updates(data)
    all_updates.extend(mtplf_updates)
    if mtplf_analytics:
        enrichments["MTPLF"] = mtplf_analytics

    # StrategyTracker CDN (existing)
    st_updates, st_enrichments = fetch_strive_updates(data)
    all_updates.extend(st_updates)
    enrichments.update(st_enrichments)

    # BNC (NEW)
    bnc_updates, bnc_analytics = fetch_bnc_updates(data)
    all_updates.extend(bnc_updates)
    if bnc_analytics:
        enrichments["BNC"] = bnc_analytics

    # DFDV (NEW)
    dfdv_updates, dfdv_analytics = fetch_dfdv_updates(data)
    all_updates.extend(dfdv_updates)
    if dfdv_analytics:
        enrichments["DFDV"] = dfdv_analytics

    return all_updates, enrichments
```

------------------------------------------------------------------------------
PHASE 5: STOCK PRICE API INTEGRATION
------------------------------------------------------------------------------

FILE: /js/services/api.js

5A. NEW CONSTANTS AND CACHE STRUCTURE
--------------------------------------

```javascript
// Stock tickers for DATs (used for Artemis API stock price lookup)
const DAT_STOCK_TICKERS = [
    'MSTR', 'ASST', 'MTPLF', 'XXI', 'NAKA', 'ABTC',  // BTC
    'BMNR', 'SBET', 'ETHM', 'BTBT', 'BTCS', 'FGNX', 'ETHZ',  // ETH
    'FWDI', 'HSDT', 'DFDV', 'UPXI', 'STSS',  // SOL
    'PURR', 'HYPD',  // HYPE
    'BNC',  // BNB
];

// Stock price cache with per-ticker timestamps (IMPROVED from global timestamp)
let stockPriceCache = {};  // { ticker: { price, ts } }
const STOCK_CACHE_TTL = 60 * 60_000; // 1 hour

// Metaplanet price validation threshold
const MTPLF_USD_PRICE_THRESHOLD = 100;
```

5B. NEW STOCK PRICE FUNCTIONS
------------------------------

```javascript
/**
 * Fetch stock price for a DAT ticker via Artemis API.
 * Artemis supports stock tickers directly.
 */
async function fetchArtemisStockPrice(ticker) {
    if (!ARTEMIS_API_KEY) return null;
    try {
        const response = await fetch(
            `https://api.artemis.xyz/asset/${ticker}/metric/price`,
            { headers: { 'x-artemis-api-key': ARTEMIS_API_KEY } }
        );
        // Parse response...
    } catch (err) {
        console.warn(`Artemis stock price failed for ${ticker}:`, err.message);
    }
    return null;
}

/**
 * Fetch stock price from StrategyTracker CDN as fallback.
 */
async function fetchStrategyTrackerStockPrice(ticker) {
    const stTicker = ST_TICKER_MAP[ticker];
    if (!stTicker) return null;
    const data = await fetchStrategyTrackerData();
    return pm.stockPrice ?? null;
}

/**
 * Fetch stock price for a single ticker with fallback chain.
 */
export async function fetchStockPrice(ticker) {
    // Check per-ticker cache
    const cached = stockPriceCache[ticker];
    if (cached && (Date.now() - cached.ts) < STOCK_CACHE_TTL) {
        return cached.price;
    }
    // Fallback chain: Artemis -> StrategyTracker
    return _fetchWithFallback([...], price => {
        stockPriceCache[ticker] = { price, ts: Date.now() };
    });
}

/**
 * Fetch stock prices for all DAT tickers.
 */
export async function fetchAllStockPrices() { ... }

/**
 * Get cached stock price synchronously.
 */
export function getCachedStockPrice(ticker) {
    const cached = stockPriceCache[ticker];
    if (cached && (Date.now() - cached.ts) < STOCK_CACHE_TTL) {
        return cached.price;
    }
    return null;
}
```

5C. METAPLANET USD FIX
-----------------------

PROBLEM: StrategyTracker returns Metaplanet price in JPY (e.g., 475 yen)
instead of USD (~$3.12). This caused incorrect mNAV calculations.

SOLUTION:
```javascript
// Special handling for MTPLF (Metaplanet): convert JPY to USD
if (ticker === 'MTPLF' && metrics.sharePrice) {
    // First try Artemis for direct USD price
    const artemisPrice = await fetchArtemisStockPrice('MTPLF');
    if (artemisPrice !== null && artemisPrice > 0 &&
        artemisPrice < MTPLF_USD_PRICE_THRESHOLD) {
        // Artemis returns USD price directly
        metrics.sharePrice = artemisPrice;
    } else if (metrics.sharePrice > MTPLF_USD_PRICE_THRESHOLD) {
        // Price is likely in JPY, convert to USD
        const jpyRate = await fetchJpyToUsdRate();
        if (jpyRate !== null) {
            metrics.sharePrice = metrics.sharePrice * jpyRate;
        }
    }
    // Recalculate mNAV with corrected price...
}
```

NEW EXCHANGE RATE FUNCTION:
```javascript
/**
 * Fetch JPY to USD exchange rate for Metaplanet conversion.
 */
async function fetchJpyToUsdRate() {
    try {
        const response = await fetch(
            'https://api.exchangerate-api.com/v4/latest/JPY'
        );
        if (response.ok) {
            const data = await response.json();
            return data.rates?.USD ?? null;
        }
    } catch (err) {
        console.warn('JPY/USD exchange rate fetch failed:', err.message);
    }
    // Fallback: approximate rate
    return 0.0066; // ~150 JPY per USD
}
```

------------------------------------------------------------------------------
PHASE 6: ENHANCED mNAV CALCULATION AND ZERO HANDLING
------------------------------------------------------------------------------

6A. METRICS CALCULATION ENHANCEMENT
------------------------------------

FILE: /js/services/metrics.js

BEFORE:
```javascript
const mNAV = (sharePrice && navPerShare > 0)
    ? sharePrice / navPerShare
    : null;
```

AFTER:
```javascript
// Enhanced mNAV calculation with priority:
// 1. External mNAV from StrategyTracker (most reliable)
// 2. Calculated from market cap: marketCap / NAV
// 3. Calculated from share price: sharePrice / navPerShare
let mNAV = null;
if (externalMetrics.mNAV && typeof externalMetrics.mNAV === 'number' &&
    externalMetrics.mNAV > 0) {
    // Priority 1: Use external mNAV directly
    mNAV = externalMetrics.mNAV;
} else if (externalMetrics.marketCap && nav > 0) {
    // Priority 2: Calculate from market cap
    mNAV = externalMetrics.marketCap / nav;
} else if (sharePrice && navPerShare > 0) {
    // Priority 3: Calculate from share price
    mNAV = sharePrice / navPerShare;
}

// Handle edge cases: mNAV should be positive and reasonable
if (mNAV !== null && (mNAV <= 0 || mNAV > 100 || !Number.isFinite(mNAV))) {
    mNAV = null;
}
```

WHY THIS MATTERS:
- Uses most reliable data source first
- Handles missing data gracefully
- Validates output to catch calculation errors
- Provides multiple fallback options

6B. HOLDINGS VIEW ZERO HANDLING
--------------------------------

FILE: /js/views/holdings.js

BEFORE:
```javascript
if (metrics && typeof metrics.sharePrice === 'number') {
    priceEl.textContent = '$' + metrics.sharePrice.toLocaleString(...);
}
```

AFTER:
```javascript
if (metrics && typeof metrics.sharePrice === 'number' &&
    metrics.sharePrice > 0) {
    priceEl.textContent = '$' + metrics.sharePrice.toLocaleString(...);
} else {
    priceEl.innerHTML = '<span class="no-alert">\u2014</span>';
}
```

ALSO FOR mNAV:
```javascript
if (metrics && typeof metrics.mNAV === 'number' &&
    metrics.mNAV > 0 && metrics.mNAV < 100) {
    mnavEl.textContent = metrics.mNAV.toFixed(2) + 'x';
}
```

================================================================================
3. CODE QUALITY REVIEW & FIXES
================================================================================

After the initial implementation, a comprehensive code health check was
performed using a code-simplifier agent. The following issues were identified
and fixed:

CRITICAL FIXES:
---------------

1. REGEX BUG IN WEBSITE_SCRAPERS.PY
   Issue: Double-escaped \d in regex patterns
   Before: r"SOL Count[^\\d]*([\d,]+)"
   After:  r"SOL Count[^\d]*([\d,]+)"
   Impact: Would have failed to match non-digit characters

2. INTEGER PARSING IN CSV.JS
   Issue: parseInt loses decimal precision for financial data
   Before: quantity: parseInt(get('Quantity').replace(/,/g, ''), 10) || 0
   After:  quantity: Math.round(parseFloat(get('Quantity').replace(/,/g, '')) || 0)
   Impact: Could lose fractional token amounts

3. STOCK CACHE TIMESTAMP BUG IN API.JS
   Issue: Global timestamp instead of per-ticker timestamps
   Before: stockPriceCache[ticker] = price; stockPriceCacheTs = Date.now();
   After:  stockPriceCache[ticker] = { price, ts: Date.now() };
   Impact: Stale cache entries would appear fresh

MEDIUM FIXES:
-------------

4. EMPTY CATCH BLOCK IN CSV.JS
   Issue: Silent failure violates bible.md principles
   Before: } catch { // Price unavailable }
   After:  } catch (err) {
               console.warn(`Price fetch failed for ${token} on ${row.date}:`, err.message);
           }

5. NULLISH COALESCING IN METRICS.JS
   Issue: Using || instead of ?? for numeric fallbacks (0 treated as falsy)
   Before: company.transactions?.[0]?.avgCostBasis || externalMetrics.avgCostPerBtc || 0
   After:  company.transactions?.[0]?.avgCostBasis ?? externalMetrics.avgCostPerBtc ?? 0

6. NESTED TERNARY IN METRICS-FLASHCARD.JS
   Issue: Hard to read nested ternary operators
   Before: valueClass = value > 1 ? 'flashcard-value-positive' : value < 1 ? 'flashcard-value-negative' : '';
   After:  if (value > 1) { valueClass = 'flashcard-value-positive'; }
           else if (value < 1) { valueClass = 'flashcard-value-negative'; }

7. MAGIC NUMBER IN API.JS
   Issue: Unexplained threshold value
   Before: artemisPrice < 100
   After:  artemisPrice < MTPLF_USD_PRICE_THRESHOLD (with constant definition)

8. NULL CHECK FOR JPY RATE
   Issue: Missing null check could cause NaN
   Before: metrics.sharePrice = metrics.sharePrice * jpyRate;
   After:  if (jpyRate !== null) { metrics.sharePrice = metrics.sharePrice * jpyRate; }

================================================================================
4. DEVELOPER ETIQUETTE GUIDE
================================================================================

Good developer etiquette ensures code quality, team collaboration, and
maintainable software. Follow these principles:

4.1 CODE REVIEW ETIQUETTE
--------------------------

BEFORE SUBMITTING CODE:
- Run ALL tests locally: `python3 -m pytest tests/ -v`
- Validate data files: `python3 -c "import json; json.load(open('data.json'))"`
- Self-review your diff for obvious issues
- Check for console.log/print statements left in code
- Ensure no secrets/API keys are committed

WHEN REVIEWING OTHERS' CODE:
- Be constructive, not critical
- Explain WHY, not just WHAT is wrong
- Suggest alternatives, don't just reject
- Acknowledge good patterns you see
- Focus on correctness, then performance, then style

4.2 COMMIT ETIQUETTE
--------------------

COMMIT MESSAGES:
- Start with a verb: "Add", "Fix", "Update", "Remove", "Refactor"
- Keep first line under 72 characters
- Explain WHY in the body, not just WHAT
- Reference issue numbers when applicable

EXAMPLE:
```
Add Treasury Copy for IDE with selective row export

Users needed ability to copy specific rows from treasury table
for data entry. This adds:
- Checkbox column for row selection
- Select All functionality
- Copy for IDE button that respects selection

Fixes #123
```

4.3 ERROR HANDLING ETIQUETTE
-----------------------------

NEVER:
- Use empty catch blocks
- Swallow errors silently
- Return null without logging

ALWAYS:
- Log errors with context
- Provide fallback behavior
- Fail loudly in development, gracefully in production

EXAMPLE:
```javascript
// BAD
try { await fetchData(); } catch { }

// GOOD
try {
    await fetchData();
} catch (err) {
    console.warn(`Data fetch failed for ${context}:`, err.message);
    return defaultValue;
}
```

4.4 NAMING ETIQUETTE
--------------------

FUNCTIONS:
- Use verbs: fetchPrice, calculateMetrics, renderFlashcard
- Be specific: fetchArtemisStockPrice, not just getPrice
- Prefix private functions: _parseStCompany

VARIABLES:
- Use descriptive names: stockPriceCache, not spc
- Use consistent casing: camelCase in JS, snake_case in Python
- Boolean prefixes: isLoading, hasData, shouldRefresh

CONSTANTS:
- ALL_CAPS_WITH_UNDERSCORES
- Group related constants together
- Add comments explaining magic numbers

================================================================================
5. TESTING STRATEGY (FORTUNE 500 STANDARDS)
================================================================================

Top engineering organizations follow rigorous testing practices. Here's how
to implement tests that catch bugs before deployment:

5.1 TEST PYRAMID
----------------

```
                    /\
                   /  \
                  / E2E \        <- 10% of tests
                 /------\
                /  INT   \       <- 20% of tests
               /----------\
              /    UNIT    \     <- 70% of tests
             /--------------\
```

UNIT TESTS (70%):
- Test individual functions in isolation
- Mock external dependencies
- Fast execution (<100ms per test)
- High coverage of edge cases

INTEGRATION TESTS (20%):
- Test component interactions
- Use real (or realistic) data
- Test API contracts
- Verify data flow between modules

END-TO-END TESTS (10%):
- Test full user workflows
- Run against staging environment
- Verify critical paths work
- Slowest but most realistic

5.2 TEST COVERAGE REQUIREMENTS
------------------------------

MINIMUM COVERAGE STANDARDS:
- Critical paths: 100% coverage
- Business logic: 90% coverage
- Utility functions: 80% coverage
- UI components: 70% coverage

HOW TO MEASURE:
```bash
# Python
python3 -m pytest tests/ --cov=scraper --cov-report=html

# JavaScript (with Jest)
npm test -- --coverage
```

================================================================================
6. MULTI-AGENT CODE REVIEW PROCESS
================================================================================

This section describes how to implement automated code review using Claude
agents before deployment.

6.1 REVIEW AGENT ARCHITECTURE
------------------------------

```
+-------------------------------------------------------------+
|                     CODE REVIEW PIPELINE                     |
+-------------------------------------------------------------+
|                                                              |
|   +------------+     +------------+     +--------------+     |
|   |  REVIEWER  |     |  DECISION  |     |    FINAL     |     |
|   |   AGENT    |---->|   AGENT    |---->|   APPROVAL   |     |
|   |            |     |            |     |              |     |
|   | - Review   |     | - Evaluate |     | - Summary    |     |
|   | - Find bugs|     |   feedback |     | - Go/No-go   |     |
|   | - Suggest  |     | - Priority |     | - Actions    |     |
|   +------------+     +------------+     +--------------+     |
|                                                              |
+-------------------------------------------------------------+
```

6.2 AUTOMATION SCRIPT
----------------------

Create `.claude/hooks/pre-commit.sh`:
```bash
#!/bin/bash
# Pre-commit hook to run automated code review

echo "Running automated code review..."

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# Run reviewer agent via Claude Code
claude -p "Review these changed files for issues: $CHANGED_FILES" \
    --output review.json

# Check if any CRITICAL or HIGH issues
if grep -q '"severity": "CRITICAL"' review.json; then
    echo "BLOCKED: Critical issues found. See review.json"
    exit 1
fi

if grep -q '"severity": "HIGH"' review.json; then
    echo "WARNING: High severity issues found. Review before committing."
    read -p "Continue anyway? (y/n) " -n 1 -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "Code review passed."
exit 0
```

================================================================================
7. FILES MODIFIED SUMMARY
================================================================================

| File | Type | Lines Changed | Description |
|------|------|---------------|-------------|
| data.json | Data | +35 | Added holdingsKeywords to tokenConfig |
| scraper/website_scrapers.py | Python | +180 | New scrapers, field renames, regex fixes |
| js/services/api.js | JS | +130 | Stock price API, MTPLF fix, cache improvements |
| js/services/csv.js | JS | +25 | Selective export, parseInt fix, error logging |
| js/services/metrics.js | JS | +30 | Enhanced mNAV calculation |
| js/views/company.js | JS | +120 | Row selection, pre-fill enhancement |
| js/views/holdings.js | JS | +6 | Zero price handling |
| js/components/metrics-flashcard.js | JS | +8 | Ternary refactor |
| css/styles.css | CSS | +25 | Selection styling |

TOTAL: ~560 lines of new/modified code

================================================================================
8. VERIFICATION CHECKLIST
================================================================================

Before deploying, verify:

[ ] All Python tests pass: `python3 -m pytest tests/ -v`
[ ] data.json is valid JSON: `python3 -c "import json; json.load(open('data.json'))"`
[ ] No console.log debugging left in code
[ ] No hardcoded API keys or secrets
[ ] New scrapers handle network errors gracefully
[ ] Stock price cache uses per-ticker timestamps
[ ] MTPLF price displays in USD, not JPY
[ ] Treasury row selection works (select, deselect, select all)
[ ] Copy for IDE copies selected rows when rows are selected
[ ] Copy for IDE copies all rows when no rows are selected
[ ] Update banner pre-fills form correctly
[ ] mNAV calculations are reasonable (0 < mNAV < 100)

================================================================================
9. SESSION CONTINUATION - GITHUB BACKUP & LIVE DASHBOARD LINKS
================================================================================

This section documents additional features implemented in the continuation
of the January 28, 2026 session.

------------------------------------------------------------------------------
9.1 GITHUB BACKUP SYNC FEATURE
------------------------------------------------------------------------------

PURPOSE:
Export browser localStorage data to GitHub repository for safekeeping. Creates
timestamped JSON backup files in the /backups/ folder with daily reminder.

FILES CREATED:

FILE: /js/services/backup.js (NEW - 355 lines)

Core functions implemented:

1. exportLocalStorageData()
   - Collects all DAT Monitor related localStorage keys
   - Extracts treasury histories and transactions from main data store
   - Returns structured backup object with version and timestamp

2. commitToGitHub(data, token, repo)
   - Creates backup file: backups/backup-YYYY-MM-DD-HH-MM-SS.json
   - Uses GitHub API PUT to /repos/{repo}/contents/{filename}
   - Handles file creation (no SHA) and update (with SHA)
   - Returns {success, message, url}

3. shouldShowBackupReminder()
   - Returns true if no backup exists, or >24 hours since last backup
   - Respects daily dismissal (won't show again if dismissed today)

4. getBackupStats()
   - Returns summary: companies with treasury, total entries, etc.

5. restoreFromBackup(backupData)
   - Restores mainDataStore and individual localStorage items
   - Returns {success, message, restored}

6. downloadBackupFile(data)
   - Fallback: downloads backup as local .json file

FILE: /backups/.gitkeep (NEW)
   - Ensures backup directory exists in repository

------------------------------------------------------------------------------
9.2 GITHUB BACKUP UI
------------------------------------------------------------------------------

FILE: /js/views/data-sync.js

CHANGES:
- Added imports from backup.js service
- Added _renderBackupStatus() helper - shows last backup time with color coding
- Added _renderBackupStats() helper - shows data summary to be backed up
- Added "GitHub Backup Sync" section to Export/Import page:
  * GitHub token input with show/hide toggle
  * Repository configuration (owner/repo format)
  * "Backup to GitHub" button with loading state
  * "Download Backup File" fallback button
  * Result message display
  * Backup statistics panel
- Added event handlers:
  * Token/repo inputs save on blur
  * GitHub backup button validates inputs, commits to GitHub
  * Download button exports to local file

------------------------------------------------------------------------------
9.3 BACKUP REMINDER BADGE
------------------------------------------------------------------------------

FILE: /js/components/header.js

CHANGES:
- Import shouldShowBackupReminder from backup.js
- Added badge support to tabs configuration
- Export/Import tab shows orange "Backup" badge when reminder active
- Badge blinks using CSS animation to draw attention

FILE: /css/styles.css

ADDED:
```css
.nav-tab-badge {
    margin-left: 6px;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 600;
    background: var(--orange);
    color: white;
    text-transform: uppercase;
    animation: blink 2s infinite;
}
```

------------------------------------------------------------------------------
9.4 LIVE DASHBOARD DROPDOWN
------------------------------------------------------------------------------

PURPOSE:
Make the "Live" status indicator in the header clickable, revealing a dropdown
menu with links to official DAT company dashboards and data sources.

FILE: /js/components/header.js

CHANGES:
- Added LIVE_DASHBOARDS constant array with 8 official dashboard URLs:
  * StrategyTracker (all BTC DATs)
  * Strategy/MSTR (BTC purchases)
  * Metaplanet (BTC analytics)
  * Strive/ASST (BTC treasury)
  * CEA Industries/BNC (BNB dashboard)
  * DeFi Dev/DFDV (SOL purchases)
  * SharpLink/SMLR (ETH dashboard)
  * SaylorTracker (MSTR tracker)

- Modified header-status div:
  * Added live-dropdown-trigger class and ID
  * Added dropdown arrow SVG icon
  * Added live-dropdown div with header and items
  * Each item links to external dashboard with target="_blank"

FILE: /css/styles.css

ADDED (~60 lines):
```css
.live-dropdown-trigger {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: background 0.15s;
    position: relative;
}
.live-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 220px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
}
.live-dropdown.show {
    display: block;
}
.live-dropdown-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    text-decoration: none;
    color: var(--text-primary);
}
.live-dropdown-item:hover {
    background: var(--purple-bg);
}
```

FILE: /js/app.js

ADDED:
- Event listener for live dropdown toggle
- Clicking trigger toggles dropdown visibility
- Clicking outside closes dropdown
- Uses event delegation pattern for efficiency

------------------------------------------------------------------------------
9.5 SESSION FILES SUMMARY
------------------------------------------------------------------------------

| File | Type | Lines Changed | Description |
|------|------|---------------|-------------|
| js/services/backup.js | JS | +355 | NEW: GitHub backup service |
| js/views/data-sync.js | JS | +110 | GitHub backup UI section |
| js/components/header.js | JS | +35 | Backup badge, live dropdown |
| js/app.js | JS | +12 | Dropdown toggle handler |
| css/styles.css | CSS | +75 | Badge + dropdown styling |
| backups/.gitkeep | - | +2 | Backup directory placeholder |

TOTAL SESSION ADDITIONS: ~589 lines

------------------------------------------------------------------------------
9.6 VERIFICATION CHECKLIST (Session Continuation)
------------------------------------------------------------------------------

[ ] GitHub backup UI renders correctly on Export/Import page
[ ] Token input shows/hides password on toggle click
[ ] "Backup to GitHub" validates token and repo before submitting
[ ] Backup file appears in /backups/ folder on GitHub
[ ] Last backup time updates after successful backup
[ ] Backup reminder badge appears after 24+ hours
[ ] Badge disappears after successful backup
[ ] "Live" indicator is clickable with visible dropdown arrow
[ ] Dropdown shows all 8 dashboard links
[ ] Dropdown closes when clicking outside
[ ] All links open in new tabs
[ ] Download backup file works as fallback

================================================================================
10. FILING FEED, IR SCRAPER & PRICE API ENHANCEMENTS (NEW)
================================================================================

This section documents features implemented to address FGNX filing issues,
chart display problems, and stock price reliability.

------------------------------------------------------------------------------
10.1 FILING FEED VIEW WITH AI SUMMARIES
------------------------------------------------------------------------------

PURPOSE:
Create a dedicated view to display all recent SEC filings from tracked DAT
companies, with AI-powered summary generation for quick analysis.

FILES CREATED/MODIFIED:

FILE: /js/views/filing-feed.js (NEW - 220 lines)

Features:
- Token filter dropdown (All, BTC, ETH, SOL, HYPE, BNB)
- "NEW" badge for filings within 2 days
- Filing type badges (8-K, 10-Q, 10-K, S-1, PR)
- Change column with +/- color coding
- AI Summary button with Claude integration
- Discovered Press Releases section (from IR scraper)

FILE: /js/services/filing-feed.js (NEW - 180 lines)

Functions:
- getRecentFilings(options) - aggregates filings from last 7 days
- formatFilingDate(dateStr) - relative date formatting
- getDiscoveredPressReleases(options) - returns IR-scraped PRs
- getCompanyByTicker(ticker) - company lookup helper

FILE: /js/services/ai-summary.js (NEW - 260 lines)

Features:
- Dual-layer caching (memory + localStorage, 7-day TTL)
- Claude API integration for SEC filing summaries
- Popup UI with loading states
- Cache management (clearCache, _evictOldest)

FILE: /css/styles.css

ADDED (~150 lines):
- Filing Feed header and controls styling
- Filing type badges (8k, 10q, 10k, s1, pr)
- AI summary button and popup styling
- Discovered press releases section
- Responsive adjustments

------------------------------------------------------------------------------
10.2 CODE QUALITY FIXES (BIBLE.MD COMPLIANCE)
------------------------------------------------------------------------------

ISSUE 1: Empty catch in clearCache()
FILE: /js/services/ai-summary.js:150-152
BEFORE: } catch { // Ignore storage errors }
AFTER:  } catch (e) { console.warn('AISummary: Failed to clear localStorage cache', e); }

ISSUE 2: Empty catch in _loadFromStorage()
FILE: /js/services/ai-summary.js:194-196
BEFORE: } catch { localStorage.removeItem(key); }
AFTER:  } catch (e) { console.warn(`AISummary: Failed to parse cache entry ${key}`, e); localStorage.removeItem(key); }

ISSUE 3: Empty catch in _evictOldest()
FILE: /js/services/ai-summary.js:229-231
BEFORE: } catch { // Ignore }
AFTER:  } catch (e) { console.warn(`AISummary: Failed to remove cache entry ${key}`, e); }

ISSUE 4: Empty catch in enrichTransactionsWithPrices()
FILE: /js/services/csv.js:330-332
BEFORE: } catch { // Price unavailable }
AFTER:  } catch (err) { console.warn(`Price enrichment failed for ${token} on ${txn.date}:`, err.message); }

ISSUE 5: Timer leak in AI popup
FILE: /js/services/ai-summary.js:119-131
FIX: Added module-level autoCloseTimer and outsideClickHandler, cleared in hidePopup()

ISSUE 6: Fragile re-render using HashChangeEvent
FILE: /js/views/filing-feed.js:140
BEFORE: window.dispatchEvent(new HashChangeEvent('hashchange'));
AFTER:  route();  // Direct call to exported route function

ISSUE 7: Error logging for AI summary failures
FILE: /js/views/filing-feed.js:163
ADDED: console.error(`AISummary: Failed to generate summary for ${ticker}:`, err);

------------------------------------------------------------------------------
10.3 IR PAGE SCRAPER FOR PRESS RELEASE DISCOVERY
------------------------------------------------------------------------------

PURPOSE:
Scrape company IR/news pages to discover press releases that may not appear
in SEC filings. Addresses issue where FGNX and other DATs were missing filings.

FILE: /scraper/ir_scraper.py (NEW - 350 lines)

Features:

1. DiscoveredPR dataclass
   - Stores: ticker, token, title, url, date, source_page, discovered_at
   - JSON serialization via to_json_dict()

2. _http_get(url)
   - Browser-like User-Agent to avoid bot blocking
   - SSL certificate handling for sites with issues
   - Gzip decompression support

3. _extract_date_from_text(text)
   - Parses multiple date formats: US, ISO, EU
   - Returns ISO format or None

4. _is_crypto_related(text)
   - Keyword detection for crypto-related announcements
   - Keywords: bitcoin, btc, eth, treasury, holdings, acquired, etc.

5. _extract_press_releases(html, base_url)
   - Regex-based link extraction from HTML
   - Filters navigation/non-PR links
   - Deduplicates by URL

6. JS_RENDERED_PLATFORMS list
   - Known platforms that can't be scraped: q4cdn.com, q4inc.com,
     investors.strive.com, ir.upexi.com, ir.hyperiondefi.com

7. _scrape_globenewswire(company_name, ticker, token)
   - Fallback for JS-rendered platforms
   - Searches GlobeNewswire by ticker symbol
   - Extracts press release links and dates

8. scrape_ir_page(ticker, token, ir_url)
   - Main scraping function
   - Detects JS platforms and falls back to GlobeNewswire
   - Combines IR page results with wire service results

9. scrape_all_ir_pages(data)
   - Iterates all companies in data.json
   - Aggregates discovered PRs

10. merge_discovered_prs(existing, new_prs)
    - Deduplicates by URL
    - Filters by age (30 days default)
    - Sorts by date descending

FILE: /scraper/run.py

CHANGES:
- Import ir_scraper module
- Add step 2c: IR page scraping after website scrapers
- Store discovered PRs in data.json under "discoveredPressReleases"
- Update summary logging to include PR count

FILE: /tests/test_ir_scraper.py (NEW - 120 lines)

Test coverage:
- TestExtractDateFromText (6 tests)
- TestIsCryptoRelated (5 tests)
- TestExtractPressReleases (4 tests)
- TestDiscoveredPR (1 test)
- TestMergeDiscoveredPRs (3 tests)

Total: 19 new tests, all passing

------------------------------------------------------------------------------
10.4 CHART TIMEFRAME AND DATA DISPLAY FIXES
------------------------------------------------------------------------------

PROBLEM: Charts showed "Not enough data" or 0 when timeframe filtered out
all available data points.

FILE: /js/views/company.js

CHANGES TO _getChartData():

BEFORE:
```javascript
// Filter by timeframe
if (timeframe !== 'ALL') {
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - tf.days);
    const cutoffStr = cutoff.toISOString().slice(0, 10);
    rawData = rawData.filter(d => d.date >= cutoffStr);
}

// Add today's point if only one data point
if (rawData.length === 1) {
    rawData.push({
        date: new Date().toISOString().slice(0, 10),
        cumulativeTokens: rawData[0].cumulativeTokens,
    });
}
```

AFTER:
```javascript
// Sort by date ascending for proper chart display
rawData.sort((a, b) => a.date.localeCompare(b.date));

// Filter by timeframe - but keep data if filter results in empty
if (timeframe !== 'ALL' && rawData.length > 0) {
    const tf = TIMEFRAMES.find(t => t.key === timeframe);
    if (tf && tf.days) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - tf.days);
        const cutoffStr = cutoff.toISOString().slice(0, 10);
        const filtered = rawData.filter(d => d.date >= cutoffStr);

        // Only use filtered data if we have at least 1 point
        // Otherwise, show all available data
        if (filtered.length > 0) {
            rawData = filtered;
        }
    }
}

// Add today's point with current value if we have data
if (rawData.length >= 1) {
    const today = new Date().toISOString().slice(0, 10);
    const lastEntry = rawData[rawData.length - 1];

    // Only add today's point if last entry isn't already today
    if (lastEntry.date !== today) {
        rawData.push({
            date: today,
            cumulativeTokens: lastEntry.cumulativeTokens,
        });
    }
}
```

WHY THIS MATTERS:
- Charts now show available data even when filtered timeframe has no recent data
- Data is always sorted chronologically for proper rendering
- Chart extends to today with latest value for visual continuity
- Prevents "Not enough data" message when historical data exists

------------------------------------------------------------------------------
10.5 YAHOO FINANCE STOCK PRICE API INTEGRATION
------------------------------------------------------------------------------

PROBLEM: Artemis API was unreliable for stock prices, causing missing/broken
price displays throughout the application.

FILE: /js/services/api.js

NEW FUNCTION:
```javascript
/**
 * Fetch stock price via Yahoo Finance API (free, no auth required).
 * Uses the query1 endpoint which returns quote data.
 * @param {string} ticker - Stock ticker (e.g., 'MSTR', 'ASST')
 * @returns {number|null} - Price in USD, or null if unavailable
 */
async function fetchYahooFinanceStockPrice(ticker) {
    // Map our tickers to Yahoo Finance symbols
    const yahooTicker = ticker === 'MTPLF' ? '3350.T' : ticker;

    try {
        const response = await fetch(
            `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?interval=1d&range=1d`
        );

        if (!response.ok) return null;
        const data = await response.json();

        // Extract current price from chart data
        const meta = data?.chart?.result?.[0]?.meta;
        const rawPrice = meta?.regularMarketPrice ?? meta?.previousClose;
        if (rawPrice === undefined) return null;

        // Convert JPY to USD for Japanese stocks
        if (yahooTicker.endsWith('.T') && rawPrice > MTPLF_USD_PRICE_THRESHOLD) {
            const jpyRate = await fetchJpyToUsdRate();
            return jpyRate ? rawPrice * jpyRate : rawPrice;
        }
        return rawPrice;
    } catch (err) {
        console.warn(`Yahoo Finance stock price failed for ${ticker}:`, err.message);
    }
    return null;
}
```

UPDATED FALLBACK CHAIN:
```javascript
export async function fetchStockPrice(ticker) {
    // Check per-ticker cache
    const cached = stockPriceCache[ticker];
    if (cached && (Date.now() - cached.ts) < STOCK_CACHE_TTL) {
        return cached.price;
    }

    // Fallback chain: Yahoo Finance -> Artemis -> StrategyTracker
    return _fetchWithFallback([
        { fn: () => fetchYahooFinanceStockPrice(ticker), label: `Yahoo Finance price failed for ${ticker}` },
        { fn: () => fetchArtemisStockPrice(ticker), label: `Artemis stock price failed for ${ticker}` },
        { fn: () => fetchStrategyTrackerStockPrice(ticker), label: `StrategyTracker price failed for ${ticker}` },
    ], price => {
        stockPriceCache[ticker] = { price, ts: Date.now() };
    });
}
```

WHY THIS MATTERS:
- Yahoo Finance is free and doesn't require API key
- More reliable than Artemis for stock prices
- Proper JPY to USD conversion for Japanese stocks (MTPLF)
- Falls back to other sources if Yahoo fails

------------------------------------------------------------------------------
10.6 FILES MODIFIED/CREATED (Section 10)
------------------------------------------------------------------------------

| File | Type | Lines | Description |
|------|------|-------|-------------|
| js/views/filing-feed.js | JS | +220 | NEW: Filing feed view |
| js/services/filing-feed.js | JS | +180 | NEW: Filing feed service |
| js/services/ai-summary.js | JS | +260 | NEW: AI summary service |
| js/services/api.js | JS | +80 | Yahoo Finance integration |
| js/views/company.js | JS | +30 | Chart timeframe fixes |
| js/app.js | JS | +5 | Export route() function |
| js/components/header.js | JS | +3 | Filings tab |
| js/config.example.js | JS | +1 | Claude API key |
| scraper/ir_scraper.py | Python | +350 | NEW: IR page scraper |
| scraper/run.py | Python | +20 | IR scraper integration |
| tests/test_ir_scraper.py | Python | +120 | NEW: IR scraper tests |
| css/styles.css | CSS | +200 | Filing feed + PR section |

TOTAL SECTION 10: ~1,469 lines of new/modified code

------------------------------------------------------------------------------
10.7 VERIFICATION CHECKLIST (Section 10)
------------------------------------------------------------------------------

Filing Feed:
[ ] Navigate to #/filings - view loads
[ ] Filings display with correct data
[ ] Token filter dropdown works
[ ] "View" link opens SEC filing in new tab
[ ] "NEW" badge appears for recent filings (within 2 days)
[ ] Filing type badges show correct colors
[ ] Change column shows +/- with color coding
[ ] AI button shows loading state when clicked
[ ] AI popup appears near button
[ ] Cached summary loads instantly on second click
[ ] Popup closes on X button
[ ] Popup closes on click outside

Discovered Press Releases:
[ ] Section appears below filing table
[ ] Shows count in header
[ ] PRs display with ticker, title, date, source
[ ] "View PR" and "IR Page" links work
[ ] Toggle show/hide works

Charts:
[ ] Charts show data even when timeframe filter has no recent data
[ ] Charts extend to today with latest value
[ ] New data entries appear after page refresh
[ ] FGNX chart updates correctly with new entries

Stock Prices:
[ ] Share prices display for all DATs
[ ] MTPLF price shows in USD (not JPY)
[ ] Prices update within 1 hour cache TTL

IR Scraper:
[ ] All 132 Python tests pass
[ ] Scraper runs without errors: `python -m scraper.run --dry-run`
[ ] Discovered PRs appear in data.json
[ ] JS-rendered sites (Strive) fall back to GlobeNewswire search

================================================================================
11. CODE SIMPLIFICATION PASS (NEW)
================================================================================

A code-simplifier agent reviewed all recently modified code and made the
following improvements for clarity, consistency, and maintainability.

------------------------------------------------------------------------------
11.1 API.JS SIMPLIFICATIONS
------------------------------------------------------------------------------

FILE: /js/services/api.js

fetchYahooFinanceStockPrice function:

BEFORE: Duplicated JPY conversion logic in two separate code paths
```javascript
if (data?.chart?.result?.[0]?.meta?.regularMarketPrice) {
    let price = data.chart.result[0].meta.regularMarketPrice;
    if (yahooTicker.endsWith('.T') && price > MTPLF_USD_PRICE_THRESHOLD) {
        const jpyRate = await fetchJpyToUsdRate();
        if (jpyRate) { price = price * jpyRate; }
    }
    return price;
}
if (data?.chart?.result?.[0]?.meta?.previousClose) {
    let price = data.chart.result[0].meta.previousClose;
    if (yahooTicker.endsWith('.T') && price > MTPLF_USD_PRICE_THRESHOLD) {
        const jpyRate = await fetchJpyToUsdRate();
        if (jpyRate) { price = price * jpyRate; }
    }
    return price;
}
```

AFTER: Consolidated using nullish coalescing
```javascript
const meta = data?.chart?.result?.[0]?.meta;
const rawPrice = meta?.regularMarketPrice ?? meta?.previousClose;
if (rawPrice === undefined) return null;

if (yahooTicker.endsWith('.T') && rawPrice > MTPLF_USD_PRICE_THRESHOLD) {
    const jpyRate = await fetchJpyToUsdRate();
    return jpyRate ? rawPrice * jpyRate : rawPrice;
}
return rawPrice;
```

------------------------------------------------------------------------------
11.2 COMPANY.JS SIMPLIFICATIONS
------------------------------------------------------------------------------

FILE: /js/views/company.js

Unit label determination:

BEFORE: Nested ternary operators
```javascript
const unitLabel = metricConfig?.unit === 'usd' ? 'USD' :
                  metricConfig?.unit === 'tokens' ? company.token :
                  metricConfig?.label || '';
```

AFTER: Explicit if/else chain
```javascript
let unitLabel = metricConfig?.label || '';
if (metricConfig?.unit === 'usd') {
    unitLabel = 'USD';
} else if (metricConfig?.unit === 'tokens') {
    unitLabel = company.token;
}
```

_getChartData metric value computation:

BEFORE: Repetitive if/else-if chain for each metric
```javascript
if (metric === 'nav') {
    rawData = treasuryHistory.map(entry => {
        const tokens = entry.num_of_tokens || 0;
        const cash = entry.latest_cash || 0;
        const debt = (entry.convertible_debt || 0) + (entry.non_convertible_debt || 0);
        const nav = (tokens * tokenPrice) + cash - debt;
        return { date: entry.date, cumulativeTokens: nav };
    });
} else if (metric === 'shares') {
    // Similar pattern...
} else if (metric === 'cash') {
    // Similar pattern...
}
```

AFTER: Extracted helper function with switch statement
```javascript
function _computeMetricValue(entry, metric, tokenPrice) {
    switch (metric) {
        case 'nav': {
            const tokens = entry.num_of_tokens || 0;
            const cash = entry.latest_cash || 0;
            const debt = (entry.convertible_debt || 0) + (entry.non_convertible_debt || 0);
            return (tokens * tokenPrice) + cash - debt;
        }
        case 'shares':
            return entry.num_of_shares || 0;
        case 'cash':
            return entry.latest_cash || 0;
        case 'debt':
            return (entry.convertible_debt || 0) + (entry.non_convertible_debt || 0);
        default:
            return 0;
    }
}
```

------------------------------------------------------------------------------
11.3 IR_SCRAPER.PY SIMPLIFICATIONS
------------------------------------------------------------------------------

FILE: /scraper/ir_scraper.py

_is_js_rendered_platform function:

BEFORE: Explicit for-loop with early return
```python
def _is_js_rendered_platform(url: str) -> bool:
    if not url:
        return False
    for platform in JS_RENDERED_PLATFORMS:
        if platform in url.lower():
            return True
    return False
```

AFTER: Single-line any() expression
```python
def _is_js_rendered_platform(url: str) -> bool:
    if not url:
        return False
    url_lower = url.lower()
    return any(platform in url_lower for platform in JS_RENDERED_PLATFORMS)
```

URL deduplication:

BEFORE: Identical logic duplicated in two places
```python
# In _extract_press_releases:
seen_urls = set()
unique_releases = []
for pr in releases:
    if pr["url"] not in seen_urls:
        seen_urls.add(pr["url"])
        unique_releases.append(pr)

# In scrape_ir_page (similar code)
```

AFTER: Extracted helper function
```python
def _dedupe_by_url(items: list, url_getter=lambda x: x.url):
    """Deduplicate a list of items by URL, preserving order."""
    seen = set()
    result = []
    for item in items:
        url = url_getter(item)
        if url not in seen:
            seen.add(url)
            result.append(item)
    return result
```

------------------------------------------------------------------------------
11.4 SIMPLIFICATION SUMMARY
------------------------------------------------------------------------------

| File | Change | Impact |
|------|--------|--------|
| api.js | Consolidated JPY conversion | -8 lines, clearer flow |
| company.js | Explicit if/else for unit label | +2 lines, more readable |
| company.js | Extracted _computeMetricValue | -15 lines, DRY principle |
| ir_scraper.py | any() expression | -4 lines, more Pythonic |
| ir_scraper.py | _dedupe_by_url helper | -6 lines, reusable |

All changes preserve original functionality. Test suite (132 tests) passes.

================================================================================
                              END OF DOCUMENTATION
================================================================================

TOTAL CHANGES IN V2:
- Section 10: ~1,469 lines (Filing Feed, IR Scraper, Prices)
- Section 11: ~25 lines (Code simplification)
- GRAND TOTAL: ~2,643 lines of new/modified code since original document

ALL 132 TESTS PASSING
