================================================================================
                    DAT MONITOR V3 OVERHAUL - SESSION DOCUMENTATION
                              January 28, 2026
================================================================================

TABLE OF CONTENTS
-----------------
1. Executive Summary
2. Changes by Phase
3. Code Quality Review & Fixes
4. Developer Etiquette Guide
5. Testing Strategy (Fortune 500 Standards)
6. Multi-Agent Code Review Process
7. Files Modified Summary
8. Verification Checklist

================================================================================
1. EXECUTIVE SUMMARY
================================================================================

This session implemented a major overhaul of the DAT Monitor application,
covering treasury data export, new dashboard scrapers, stock price API
integration, Metaplanet USD price fixes, and comprehensive metrics calculation
improvements.

Key Accomplishments:
- Added holdingsKeywords to all token configurations
- Extended StrategyTrackerCompany with shares outstanding fields
- Implemented Treasury Copy for IDE with selective row export
- Enhanced update banner with form pre-fill functionality
- Added BNC (CEA Industries) and DFDV scrapers
- Integrated stock price API with Artemis fallback
- Fixed Metaplanet JPY to USD conversion
- Enhanced mNAV calculation with priority-based logic
- Fixed 8 code quality issues identified by health check

================================================================================
2. CHANGES BY PHASE
================================================================================

------------------------------------------------------------------------------
PHASE 1: DATA MODEL & KEYWORDS
------------------------------------------------------------------------------

FILE: /data.json

WHAT WAS CHANGED:
Added `holdingsKeywords` array to each token configuration in the tokenConfig
object. These keywords are used by scrapers to identify token holdings in
dashboard text.

BEFORE:
```json
"SOL": {
  "name": "Solana",
  "minHoldings": 100,
  "maxHoldings": 100000000,
  "keywords": ["solana", "sol"]
}
```

AFTER:
```json
"SOL": {
  "name": "Solana",
  "minHoldings": 100,
  "maxHoldings": 100000000,
  "keywords": ["solana", "sol"],
  "holdingsKeywords": [
    "SOL Count",
    "SOL Holdings",
    "Total SOL",
    "Solana Holdings"
  ]
}
```

WHY THIS MATTERS:
- Provides token-specific keywords for dashboard scraping
- Allows scrapers to identify holdings values in varied text formats
- Supports multi-token companies with different display conventions
- Improves accuracy of automated data extraction

TOKENS UPDATED: BTC, ETH, SOL, HYPE, BNB

ADDITIONAL FIX:
Fixed a syntax error in data.json - missing comma after "lastSecUpdate" field
on line 179 for the MSTR company entry.

------------------------------------------------------------------------------
PHASE 1.2: EXTEND STRATEGYTRACKER COMPANY WITH SHARES FIELDS
------------------------------------------------------------------------------

FILE: /scraper/website_scrapers.py

WHAT WAS CHANGED:
Renamed fields in StrategyTrackerCompany dataclass to use clearer terminology
for shares outstanding tracking.

BEFORE:
```python
shares_outstanding: Optional[int]
diluted_shares: Optional[int]
```

AFTER:
```python
basic_shares_outstanding: Optional[int]   # Common shares outstanding
fully_diluted_shares: Optional[int]       # Assumed diluted shares outstanding
```

WHY THIS MATTERS:
- Clearer field names distinguish common vs diluted shares
- Supports future functionality for fully diluted mNAV calculations
- Aligns with financial reporting standards terminology
- Makes code self-documenting for financial calculations

FIELD MAPPING UPDATED:
```python
_ST_FIELDS = [
    ("basic_shares_outstanding", "sharesOutstanding"),
    ("fully_diluted_shares", "fullyDilutedShares"),
    ...
]
```

------------------------------------------------------------------------------
PHASE 2: TREASURY COPY FOR IDE WITH ROW SELECTION
------------------------------------------------------------------------------

FILES MODIFIED:
- /js/services/csv.js
- /js/views/company.js
- /css/styles.css

2A. CSV SERVICE ENHANCEMENT
----------------------------

FILE: /js/services/csv.js

NEW FUNCTION ADDED:
```javascript
/**
 * Format selected treasury history entries for IDE copy.
 * @param {Array} treasuryHistory - Full treasury history array
 * @param {Set<string>} selectedDates - Set of selected date strings
 * @returns {string} CSV-formatted string for IDE
 */
export function formatSelectedTreasuryForIDE(treasuryHistory, selectedDates) {
    const header = 'date,num_of_tokens,convertible_debt,...';
    const filtered = treasuryHistory.filter(e => selectedDates.has(e.date));
    const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
    const rows = sorted.map(e => [...].join(','));
    return [header, ...rows].join('\n');
}
```

WHY THIS MATTERS:
- Allows users to copy only selected rows to clipboard
- Maintains data integrity with proper CSV formatting
- Supports IDE-friendly format for quick data entry
- Filters by date selection set for precision

2B. COMPANY VIEW UI ENHANCEMENT
--------------------------------

FILE: /js/views/company.js

HTML CHANGES:
- Added "Copy for IDE" button next to "Export CSV"
- Added checkbox column as first column in treasury table
- Added "Select All" checkbox in table header
- Moved "Copy for IDE" button to be visible in Treasury Metrics section

NEW FUNCTION ADDED:
```javascript
// Module-level state for treasury row selection
let _selectedTreasuryDates = new Set();

function _initTreasurySelection(ticker, company) {
    // Select All checkbox handling
    selectAllCheckbox.addEventListener('change', () => {
        const isChecked = selectAllCheckbox.checked;
        rowCheckboxes.forEach(cb => {
            cb.checked = isChecked;
            // Update row styling and selection state
        });
    });

    // Individual row checkbox handling
    rowCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // Toggle selection state
            // Update select all checkbox indeterminate state
        });
    });

    // Copy for IDE button - copies selected rows (or all if none selected)
    copyIdeBtn.addEventListener('click', (e) => {
        let text;
        if (_selectedTreasuryDates.size > 0) {
            text = formatSelectedTreasuryForIDE(treasuryHistory, _selectedTreasuryDates);
        } else {
            text = formatTreasuryForIDE(treasuryHistory);
        }
        navigator.clipboard.writeText(text);
    });
}
```

WHY THIS MATTERS:
- Users can select specific rows for export
- Supports bulk selection via "Select All"
- Visual feedback with row highlighting
- Graceful fallback to all rows when none selected

2C. CSS STYLING
----------------

FILE: /css/styles.css

NEW STYLES ADDED:
```css
/* Treasury Row Selection */
.treasury-row-selected {
    background: var(--purple-bg) !important;
}
.treasury-row-selected:hover {
    background: var(--purple-bg-hover) !important;
}
.treasury-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--purple);
}
.treasury-checkbox-header {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--purple);
}
.btn-danger {
    background: var(--red-bg);
    color: var(--red);
    border: 1px solid rgba(255, 80, 0, 0.2);
}
```

WHY THIS MATTERS:
- Consistent styling with Artemis Purple theme
- Visual feedback for selected rows
- Accessible checkbox sizing
- Danger button styling for destructive actions

------------------------------------------------------------------------------
PHASE 3: UPDATE BANNER PRE-FILL ENHANCEMENT
------------------------------------------------------------------------------

FILE: /js/views/company.js

WHAT WAS CHANGED:
Enhanced the `_checkForUpdateDelta()` function to automatically pre-fill the
treasury entry form when the update banner shows.

BEFORE:
```javascript
function _checkForUpdateDelta(company, metrics) {
    if (delta > threshold && liveHoldings > latestLocal) {
        banner.style.display = 'flex';
        // No pre-fill functionality
    }
}
```

AFTER:
```javascript
function _checkForUpdateDelta(company, metrics) {
    if (delta > threshold && liveHoldings > latestLocal) {
        banner.style.display = 'flex';
        // Pre-fill the form with live metrics and latest treasury data
        _prefillFormFromMetrics(metrics, latestTreasury);
    }
}
```

NEW HELPER FUNCTION:
```javascript
/**
 * Pre-fill the treasury entry form with live metrics and fallback to latest
 * treasury data.
 * @param {Object} liveMetrics - External metrics from StrategyTracker
 * @param {Object|null} latestTreasury - Most recent treasury_history entry
 */
function _prefillFormFromMetrics(liveMetrics, latestTreasury) {
    // Pre-fill tokens from live holdings
    if (tokensInput && liveMetrics?.btcHoldings) {
        tokensInput.value = Math.round(liveMetrics.btcHoldings);
    }

    // Pre-fill shares outstanding: priority is live metrics > latest treasury
    if (sharesInput) {
        if (liveMetrics?.sharesOutstanding) {
            sharesInput.value = Math.round(liveMetrics.sharesOutstanding);
        } else if (latestTreasury?.num_of_shares) {
            sharesInput.value = latestTreasury.num_of_shares;
        }
    }

    // Pre-fill other fields from latest treasury if available
    const fieldsToPreserve = [
        { inputId: 'entry-conv-debt', field: 'convertible_debt' },
        { inputId: 'entry-conv-shares', field: 'convertible_debt_shares' },
        { inputId: 'entry-non-conv-debt', field: 'non_convertible_debt' },
        { inputId: 'entry-warrants', field: 'warrants' },
        { inputId: 'entry-warrant-shares', field: 'warrant_shares' },
        { inputId: 'entry-cash', field: 'latest_cash' },
    ];
    // ... iterate and pre-fill
}
```

WHY THIS MATTERS:
- Reduces manual data entry when updating treasury
- Prevents user error from copying values manually
- Preserves existing debt/warrant values automatically
- Uses most recent data from live sources

------------------------------------------------------------------------------
PHASE 4: NEW DASHBOARD SCRAPERS (BNC, DFDV)
------------------------------------------------------------------------------

FILE: /scraper/website_scrapers.py

4A. BNC (CEA INDUSTRIES) SCRAPER
---------------------------------

PURPOSE: Scrape BNB holdings from CEA Industries data.js file

NEW DATACLASS:
```python
@dataclass(frozen=True)
class BNCAnalytics:
    """Data extracted from CEA Industries data.js."""
    total_bnb: Optional[int]
    avg_cost_basis: Optional[float]
    mnav: Optional[float]

    def to_json_dict(self) -> dict:
        result: dict = {}
        if self.total_bnb is not None:
            result["totalBnb"] = self.total_bnb
        if self.avg_cost_basis is not None:
            result["avgCostBasis"] = self.avg_cost_basis
        if self.mnav is not None:
            result["mNAV"] = self.mnav
        return result
```

NEW FUNCTIONS:
```python
def _parse_bnc_data(text: str) -> BNCAnalytics:
    """Parse BNC data.js content to extract BNB holdings."""
    # Look for totalHoldings: XXXX pattern
    # Look for avgCostBasis: XX.XX pattern
    # Look for mNAV: X.XX pattern
    ...

def fetch_bnc_updates(data: dict) -> tuple[list[ScrapedUpdate], dict | None]:
    """Fetch BNC (CEA Industries) data from data.js."""
    ...
```

WHY THIS MATTERS:
- Adds automated tracking for BNB treasury company
- Extracts multiple metrics (holdings, cost basis, mNAV)
- Follows existing scraper patterns for consistency

4B. DFDV (DEFI DEVELOPMENT) SCRAPER
------------------------------------

PURPOSE: Scrape SOL holdings from DeFi Development dashboard

NEW DATACLASS:
```python
@dataclass(frozen=True)
class DFDVAnalytics:
    """Data extracted from DeFi Development dashboard."""
    total_sol: Optional[int]
    shares_outstanding: Optional[int]

    def to_json_dict(self) -> dict:
        result: dict = {}
        if self.total_sol is not None:
            result["totalSol"] = self.total_sol
        if self.shares_outstanding is not None:
            result["sharesOutstanding"] = self.shares_outstanding
        return result
```

NEW FUNCTIONS:
```python
def _parse_dfdv_data(text: str) -> DFDVAnalytics:
    """Parse DFDV dashboard HTML to extract SOL holdings and shares."""
    # Look for SOL count patterns: "X,XXX,XXX SOL" or "SOL Count: X,XXX,XXX"
    for pattern in [
        r"([\d,]+)\s*SOL(?:\s|$|<)",
        r"SOL Count[^\d]*([\d,]+)",   # FIXED: was [^\\d]
        r"Total SOL[^\d]*([\d,]+)",   # FIXED: was [^\\d]
    ]:
        ...

    # Look for shares outstanding patterns
    for pattern in [
        r"Shares Outstanding[^\d]*([\d,]+)",  # FIXED: was [^\\d]
        r"Common Shares[^\d]*([\d,]+)",       # FIXED: was [^\\d]
        r"Outstanding[^\d]*([\d,]+)\s*shares",
    ]:
        ...

def fetch_dfdv_updates(data: dict) -> tuple[list[ScrapedUpdate], dict | None]:
    """Fetch DFDV (DeFi Development) data from dashboard."""
    ...
```

WHY THIS MATTERS:
- Adds automated tracking for major SOL treasury company
- Extracts both holdings and shares outstanding
- Enables mNAV calculation for DFDV

4C. INTEGRATION INTO BUILD_WEBSITE_UPDATES
-------------------------------------------

```python
def build_website_updates(data: dict) -> tuple[list[ScrapedUpdate], dict[str, dict]]:
    """Run all website scrapers. Returns (updates, enrichments)."""
    all_updates: list[ScrapedUpdate] = []
    enrichments: dict[str, dict] = {}

    # Metaplanet (existing)
    mtplf_updates, mtplf_analytics = fetch_metaplanet_updates(data)
    all_updates.extend(mtplf_updates)
    if mtplf_analytics:
        enrichments["MTPLF"] = mtplf_analytics

    # StrategyTracker CDN (existing)
    st_updates, st_enrichments = fetch_strive_updates(data)
    all_updates.extend(st_updates)
    enrichments.update(st_enrichments)

    # BNC (NEW)
    bnc_updates, bnc_analytics = fetch_bnc_updates(data)
    all_updates.extend(bnc_updates)
    if bnc_analytics:
        enrichments["BNC"] = bnc_analytics

    # DFDV (NEW)
    dfdv_updates, dfdv_analytics = fetch_dfdv_updates(data)
    all_updates.extend(dfdv_updates)
    if dfdv_analytics:
        enrichments["DFDV"] = dfdv_analytics

    return all_updates, enrichments
```

------------------------------------------------------------------------------
PHASE 5: STOCK PRICE API INTEGRATION
------------------------------------------------------------------------------

FILE: /js/services/api.js

5A. NEW CONSTANTS AND CACHE STRUCTURE
--------------------------------------

```javascript
// Stock tickers for DATs (used for Artemis API stock price lookup)
const DAT_STOCK_TICKERS = [
    'MSTR', 'ASST', 'MTPLF', 'XXI', 'NAKA', 'ABTC',  // BTC
    'BMNR', 'SBET', 'ETHM', 'BTBT', 'BTCS', 'FGNX', 'ETHZ',  // ETH
    'FWDI', 'HSDT', 'DFDV', 'UPXI', 'STSS',  // SOL
    'PURR', 'HYPD',  // HYPE
    'BNC',  // BNB
];

// Stock price cache with per-ticker timestamps (IMPROVED from global timestamp)
let stockPriceCache = {};  // { ticker: { price, ts } }
const STOCK_CACHE_TTL = 60 * 60_000; // 1 hour

// Metaplanet price validation threshold
const MTPLF_USD_PRICE_THRESHOLD = 100;
```

5B. NEW STOCK PRICE FUNCTIONS
------------------------------

```javascript
/**
 * Fetch stock price for a DAT ticker via Artemis API.
 * Artemis supports stock tickers directly.
 */
async function fetchArtemisStockPrice(ticker) {
    if (!ARTEMIS_API_KEY) return null;
    try {
        const response = await fetch(
            `https://api.artemis.xyz/asset/${ticker}/metric/price`,
            { headers: { 'x-artemis-api-key': ARTEMIS_API_KEY } }
        );
        // Parse response...
    } catch (err) {
        console.warn(`Artemis stock price failed for ${ticker}:`, err.message);
    }
    return null;
}

/**
 * Fetch stock price from StrategyTracker CDN as fallback.
 */
async function fetchStrategyTrackerStockPrice(ticker) {
    const stTicker = ST_TICKER_MAP[ticker];
    if (!stTicker) return null;
    const data = await fetchStrategyTrackerData();
    return pm.stockPrice ?? null;
}

/**
 * Fetch stock price for a single ticker with fallback chain.
 */
export async function fetchStockPrice(ticker) {
    // Check per-ticker cache
    const cached = stockPriceCache[ticker];
    if (cached && (Date.now() - cached.ts) < STOCK_CACHE_TTL) {
        return cached.price;
    }
    // Fallback chain: Artemis -> StrategyTracker
    return _fetchWithFallback([...], price => {
        stockPriceCache[ticker] = { price, ts: Date.now() };
    });
}

/**
 * Fetch stock prices for all DAT tickers.
 */
export async function fetchAllStockPrices() { ... }

/**
 * Get cached stock price synchronously.
 */
export function getCachedStockPrice(ticker) {
    const cached = stockPriceCache[ticker];
    if (cached && (Date.now() - cached.ts) < STOCK_CACHE_TTL) {
        return cached.price;
    }
    return null;
}
```

5C. METAPLANET USD FIX
-----------------------

PROBLEM: StrategyTracker returns Metaplanet price in JPY (e.g., 475 yen)
instead of USD (~$3.12). This caused incorrect mNAV calculations.

SOLUTION:
```javascript
// Special handling for MTPLF (Metaplanet): convert JPY to USD
if (ticker === 'MTPLF' && metrics.sharePrice) {
    // First try Artemis for direct USD price
    const artemisPrice = await fetchArtemisStockPrice('MTPLF');
    if (artemisPrice !== null && artemisPrice > 0 &&
        artemisPrice < MTPLF_USD_PRICE_THRESHOLD) {
        // Artemis returns USD price directly
        metrics.sharePrice = artemisPrice;
    } else if (metrics.sharePrice > MTPLF_USD_PRICE_THRESHOLD) {
        // Price is likely in JPY, convert to USD
        const jpyRate = await fetchJpyToUsdRate();
        if (jpyRate !== null) {
            metrics.sharePrice = metrics.sharePrice * jpyRate;
        }
    }
    // Recalculate mNAV with corrected price...
}
```

NEW EXCHANGE RATE FUNCTION:
```javascript
/**
 * Fetch JPY to USD exchange rate for Metaplanet conversion.
 */
async function fetchJpyToUsdRate() {
    try {
        const response = await fetch(
            'https://api.exchangerate-api.com/v4/latest/JPY'
        );
        if (response.ok) {
            const data = await response.json();
            return data.rates?.USD ?? null;
        }
    } catch (err) {
        console.warn('JPY/USD exchange rate fetch failed:', err.message);
    }
    // Fallback: approximate rate
    return 0.0066; // ~150 JPY per USD
}
```

------------------------------------------------------------------------------
PHASE 6: ENHANCED mNAV CALCULATION AND ZERO HANDLING
------------------------------------------------------------------------------

6A. METRICS CALCULATION ENHANCEMENT
------------------------------------

FILE: /js/services/metrics.js

BEFORE:
```javascript
const mNAV = (sharePrice && navPerShare > 0)
    ? sharePrice / navPerShare
    : null;
```

AFTER:
```javascript
// Enhanced mNAV calculation with priority:
// 1. External mNAV from StrategyTracker (most reliable)
// 2. Calculated from market cap: marketCap / NAV
// 3. Calculated from share price: sharePrice / navPerShare
let mNAV = null;
if (externalMetrics.mNAV && typeof externalMetrics.mNAV === 'number' &&
    externalMetrics.mNAV > 0) {
    // Priority 1: Use external mNAV directly
    mNAV = externalMetrics.mNAV;
} else if (externalMetrics.marketCap && nav > 0) {
    // Priority 2: Calculate from market cap
    mNAV = externalMetrics.marketCap / nav;
} else if (sharePrice && navPerShare > 0) {
    // Priority 3: Calculate from share price
    mNAV = sharePrice / navPerShare;
}

// Handle edge cases: mNAV should be positive and reasonable
if (mNAV !== null && (mNAV <= 0 || mNAV > 100 || !Number.isFinite(mNAV))) {
    mNAV = null;
}
```

WHY THIS MATTERS:
- Uses most reliable data source first
- Handles missing data gracefully
- Validates output to catch calculation errors
- Provides multiple fallback options

6B. HOLDINGS VIEW ZERO HANDLING
--------------------------------

FILE: /js/views/holdings.js

BEFORE:
```javascript
if (metrics && typeof metrics.sharePrice === 'number') {
    priceEl.textContent = '$' + metrics.sharePrice.toLocaleString(...);
}
```

AFTER:
```javascript
if (metrics && typeof metrics.sharePrice === 'number' &&
    metrics.sharePrice > 0) {
    priceEl.textContent = '$' + metrics.sharePrice.toLocaleString(...);
} else {
    priceEl.innerHTML = '<span class="no-alert">\u2014</span>';
}
```

ALSO FOR mNAV:
```javascript
if (metrics && typeof metrics.mNAV === 'number' &&
    metrics.mNAV > 0 && metrics.mNAV < 100) {
    mnavEl.textContent = metrics.mNAV.toFixed(2) + 'x';
}
```

================================================================================
3. CODE QUALITY REVIEW & FIXES
================================================================================

After the initial implementation, a comprehensive code health check was
performed using a code-simplifier agent. The following issues were identified
and fixed:

CRITICAL FIXES:
---------------

1. REGEX BUG IN WEBSITE_SCRAPERS.PY
   Issue: Double-escaped \d in regex patterns
   Before: r"SOL Count[^\\d]*([\d,]+)"
   After:  r"SOL Count[^\d]*([\d,]+)"
   Impact: Would have failed to match non-digit characters

2. INTEGER PARSING IN CSV.JS
   Issue: parseInt loses decimal precision for financial data
   Before: quantity: parseInt(get('Quantity').replace(/,/g, ''), 10) || 0
   After:  quantity: Math.round(parseFloat(get('Quantity').replace(/,/g, '')) || 0)
   Impact: Could lose fractional token amounts

3. STOCK CACHE TIMESTAMP BUG IN API.JS
   Issue: Global timestamp instead of per-ticker timestamps
   Before: stockPriceCache[ticker] = price; stockPriceCacheTs = Date.now();
   After:  stockPriceCache[ticker] = { price, ts: Date.now() };
   Impact: Stale cache entries would appear fresh

MEDIUM FIXES:
-------------

4. EMPTY CATCH BLOCK IN CSV.JS
   Issue: Silent failure violates bible.md principles
   Before: } catch { // Price unavailable }
   After:  } catch (err) {
               console.warn(`Price fetch failed for ${token} on ${row.date}:`, err.message);
           }

5. NULLISH COALESCING IN METRICS.JS
   Issue: Using || instead of ?? for numeric fallbacks (0 treated as falsy)
   Before: company.transactions?.[0]?.avgCostBasis || externalMetrics.avgCostPerBtc || 0
   After:  company.transactions?.[0]?.avgCostBasis ?? externalMetrics.avgCostPerBtc ?? 0

6. NESTED TERNARY IN METRICS-FLASHCARD.JS
   Issue: Hard to read nested ternary operators
   Before: valueClass = value > 1 ? 'flashcard-value-positive' : value < 1 ? 'flashcard-value-negative' : '';
   After:  if (value > 1) { valueClass = 'flashcard-value-positive'; }
           else if (value < 1) { valueClass = 'flashcard-value-negative'; }

7. MAGIC NUMBER IN API.JS
   Issue: Unexplained threshold value
   Before: artemisPrice < 100
   After:  artemisPrice < MTPLF_USD_PRICE_THRESHOLD (with constant definition)

8. NULL CHECK FOR JPY RATE
   Issue: Missing null check could cause NaN
   Before: metrics.sharePrice = metrics.sharePrice * jpyRate;
   After:  if (jpyRate !== null) { metrics.sharePrice = metrics.sharePrice * jpyRate; }

================================================================================
4. DEVELOPER ETIQUETTE GUIDE
================================================================================

Good developer etiquette ensures code quality, team collaboration, and
maintainable software. Follow these principles:

4.1 CODE REVIEW ETIQUETTE
--------------------------

BEFORE SUBMITTING CODE:
- Run ALL tests locally: `python3 -m pytest tests/ -v`
- Validate data files: `python3 -c "import json; json.load(open('data.json'))"`
- Self-review your diff for obvious issues
- Check for console.log/print statements left in code
- Ensure no secrets/API keys are committed

WHEN REVIEWING OTHERS' CODE:
- Be constructive, not critical
- Explain WHY, not just WHAT is wrong
- Suggest alternatives, don't just reject
- Acknowledge good patterns you see
- Focus on correctness, then performance, then style

4.2 COMMIT ETIQUETTE
--------------------

COMMIT MESSAGES:
- Start with a verb: "Add", "Fix", "Update", "Remove", "Refactor"
- Keep first line under 72 characters
- Explain WHY in the body, not just WHAT
- Reference issue numbers when applicable

EXAMPLE:
```
Add Treasury Copy for IDE with selective row export

Users needed ability to copy specific rows from treasury table
for data entry. This adds:
- Checkbox column for row selection
- Select All functionality
- Copy for IDE button that respects selection

Fixes #123
```

4.3 ERROR HANDLING ETIQUETTE
-----------------------------

NEVER:
- Use empty catch blocks
- Swallow errors silently
- Return null without logging

ALWAYS:
- Log errors with context
- Provide fallback behavior
- Fail loudly in development, gracefully in production

EXAMPLE:
```javascript
// BAD
try { await fetchData(); } catch { }

// GOOD
try {
    await fetchData();
} catch (err) {
    console.warn(`Data fetch failed for ${context}:`, err.message);
    return defaultValue;
}
```

4.4 NAMING ETIQUETTE
--------------------

FUNCTIONS:
- Use verbs: fetchPrice, calculateMetrics, renderFlashcard
- Be specific: fetchArtemisStockPrice, not just getPrice
- Prefix private functions: _parseStCompany

VARIABLES:
- Use descriptive names: stockPriceCache, not spc
- Use consistent casing: camelCase in JS, snake_case in Python
- Boolean prefixes: isLoading, hasData, shouldRefresh

CONSTANTS:
- ALL_CAPS_WITH_UNDERSCORES
- Group related constants together
- Add comments explaining magic numbers

================================================================================
5. TESTING STRATEGY (FORTUNE 500 STANDARDS)
================================================================================

Top engineering organizations follow rigorous testing practices. Here's how
to implement tests that catch bugs before deployment:

5.1 TEST PYRAMID
----------------

```
                    /\
                   /  \
                  / E2E \        <- 10% of tests
                 /------\
                /  INT   \       <- 20% of tests
               /----------\
              /    UNIT    \     <- 70% of tests
             /--------------\
```

UNIT TESTS (70%):
- Test individual functions in isolation
- Mock external dependencies
- Fast execution (<100ms per test)
- High coverage of edge cases

INTEGRATION TESTS (20%):
- Test component interactions
- Use real (or realistic) data
- Test API contracts
- Verify data flow between modules

END-TO-END TESTS (10%):
- Test full user workflows
- Run against staging environment
- Verify critical paths work
- Slowest but most realistic

5.2 RECOMMENDED TESTS TO ADD
-----------------------------

UNIT TESTS FOR CSV.JS:
```javascript
describe('formatSelectedTreasuryForIDE', () => {
    it('should filter by selected dates', () => {
        const history = [
            { date: '2026-01-01', num_of_tokens: 100 },
            { date: '2026-01-02', num_of_tokens: 200 },
            { date: '2026-01-03', num_of_tokens: 300 },
        ];
        const selected = new Set(['2026-01-01', '2026-01-03']);
        const result = formatSelectedTreasuryForIDE(history, selected);
        expect(result).toContain('2026-01-01');
        expect(result).toContain('2026-01-03');
        expect(result).not.toContain('2026-01-02');
    });

    it('should return header only when no dates selected', () => {
        const history = [{ date: '2026-01-01', num_of_tokens: 100 }];
        const selected = new Set();
        const result = formatSelectedTreasuryForIDE(history, selected);
        const lines = result.split('\n');
        expect(lines.length).toBe(1); // Header only
    });

    it('should handle null values gracefully', () => {
        const history = [{ date: '2026-01-01', num_of_tokens: null }];
        const selected = new Set(['2026-01-01']);
        const result = formatSelectedTreasuryForIDE(history, selected);
        expect(result).toContain('0.00'); // Null becomes 0
    });
});
```

UNIT TESTS FOR METRICS.JS:
```javascript
describe('calculateDATMetrics', () => {
    it('should prioritize external mNAV over calculated', () => {
        const company = { tokens: 100, treasury_history: [] };
        const externalMetrics = { mNAV: 1.5 };
        const result = calculateDATMetrics(company, 50000, 100, externalMetrics);
        expect(result.mNAV).toBe(1.5);
    });

    it('should fall back to market cap calculation', () => {
        const company = {
            tokens: 100,
            treasury_history: [{ num_of_shares: 1000000 }]
        };
        const externalMetrics = { marketCap: 10000000 };
        const result = calculateDATMetrics(company, 100, 10, externalMetrics);
        expect(result.mNAV).toBeCloseTo(1.0, 2);
    });

    it('should return null for invalid mNAV', () => {
        const company = { tokens: 100, treasury_history: [] };
        const externalMetrics = { mNAV: -1 }; // Invalid
        const result = calculateDATMetrics(company, 50000, 100, externalMetrics);
        expect(result.mNAV).toBeNull();
    });
});
```

UNIT TESTS FOR WEBSITE_SCRAPERS.PY:
```python
class TestParseBNCData:
    def test_extracts_total_bnb(self):
        text = "totalHoldings: 515,054"
        result = _parse_bnc_data(text)
        assert result.total_bnb == 515054

    def test_extracts_avg_cost_basis(self):
        text = "avgCostBasis: 425.50"
        result = _parse_bnc_data(text)
        assert result.avg_cost_basis == 425.50

    def test_handles_missing_fields(self):
        text = "some random text without data"
        result = _parse_bnc_data(text)
        assert result.total_bnb is None
        assert result.avg_cost_basis is None

class TestParseDFDVData:
    def test_extracts_sol_count_pattern1(self):
        text = "2,221,329 SOL"
        result = _parse_dfdv_data(text)
        assert result.total_sol == 2221329

    def test_extracts_sol_count_pattern2(self):
        text = "SOL Count: 2,221,329"
        result = _parse_dfdv_data(text)
        assert result.total_sol == 2221329

    def test_extracts_shares_outstanding(self):
        text = "Shares Outstanding: 150,000,000"
        result = _parse_dfdv_data(text)
        assert result.shares_outstanding == 150000000

    def test_ignores_small_sol_amounts(self):
        text = "500 SOL staking rewards"  # Too small
        result = _parse_dfdv_data(text)
        assert result.total_sol is None
```

5.3 TEST COVERAGE REQUIREMENTS
------------------------------

MINIMUM COVERAGE STANDARDS:
- Critical paths: 100% coverage
- Business logic: 90% coverage
- Utility functions: 80% coverage
- UI components: 70% coverage

HOW TO MEASURE:
```bash
# Python
python3 -m pytest tests/ --cov=scraper --cov-report=html

# JavaScript (with Jest)
npm test -- --coverage
```

5.4 CONTINUOUS INTEGRATION REQUIREMENTS
---------------------------------------

EVERY PR MUST PASS:
1. All unit tests
2. All integration tests
3. Linting (no errors)
4. Type checking (if applicable)
5. Security scan (no high/critical vulnerabilities)

MERGE BLOCKERS:
- Test coverage decreased by >2%
- New code has <80% coverage
- Any failing test
- Unresolved security issues

================================================================================
6. MULTI-AGENT CODE REVIEW PROCESS
================================================================================

This section describes how to implement automated code review using Claude
agents before deployment.

6.1 REVIEW AGENT ARCHITECTURE
------------------------------

```
┌─────────────────────────────────────────────────────────────────┐
│                     CODE REVIEW PIPELINE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐  │
│   │   REVIEWER   │     │   DECISION   │     │    FINAL     │  │
│   │    AGENT     │────▶│    AGENT     │────▶│   APPROVAL   │  │
│   │              │     │              │     │              │  │
│   │ - Code review│     │ - Evaluates  │     │ - Summary    │  │
│   │ - Find bugs  │     │   feedback   │     │ - Go/No-go   │  │
│   │ - Suggest    │     │ - Prioritize │     │ - Actions    │  │
│   │   fixes      │     │   issues     │     │   needed     │  │
│   └──────────────┘     └──────────────┘     └──────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

6.2 REVIEWER AGENT PROMPT
--------------------------

```
You are a senior code reviewer at a Fortune 500 company. Review the following
code changes with a focus on:

1. CORRECTNESS
   - Logic errors
   - Off-by-one errors
   - Null/undefined handling
   - Race conditions

2. SECURITY
   - XSS vulnerabilities
   - SQL injection
   - Sensitive data exposure
   - Input validation

3. PERFORMANCE
   - N+1 queries
   - Memory leaks
   - Unnecessary computations
   - Missing caching opportunities

4. MAINTAINABILITY
   - Code complexity
   - Naming clarity
   - Single responsibility
   - Documentation needs

5. TESTING
   - Missing test coverage
   - Edge cases not covered
   - Brittle tests

For each issue found, provide:
- Severity: CRITICAL / HIGH / MEDIUM / LOW
- Location: File and line number
- Description: What's wrong
- Recommendation: How to fix it
- Example: Code snippet if helpful

Rate overall code quality: A (ship it), B (minor fixes), C (needs work),
D (major rework), F (do not ship)
```

6.3 DECISION AGENT PROMPT
--------------------------

```
You are a technical lead evaluating code review feedback. Your job is to:

1. VALIDATE CONCERNS
   - Is this a real issue or false positive?
   - Is the severity rating appropriate?
   - Is there context the reviewer might have missed?

2. PRIORITIZE
   - Which issues block deployment?
   - Which can be fixed in a follow-up PR?
   - Which are nice-to-haves?

3. DECIDE
   - APPROVE: Code is safe to ship
   - REQUEST CHANGES: Must fix before shipping
   - DISCUSS: Need more context from author

For each reviewer concern, state:
- VALID: This is a real issue
- INVALID: False positive (explain why)
- DEFER: Fix in follow-up (explain why acceptable)

Provide final recommendation with clear action items.
```

6.4 IMPLEMENTING THE REVIEW PROCESS
------------------------------------

STEP 1: RUN REVIEWER AGENT
```bash
# Example using Claude Code Task tool
Task(
    description="Code review changes",
    prompt="""
    Review the following files that were modified in this session:
    - /js/services/api.js
    - /js/services/csv.js
    - /js/services/metrics.js
    - /js/views/company.js
    - /scraper/website_scrapers.py

    [Insert Reviewer Agent Prompt above]

    Provide detailed findings.
    """,
    subagent_type="Explore"
)
```

STEP 2: RUN DECISION AGENT
```bash
Task(
    description="Evaluate review feedback",
    prompt="""
    Given the following code review feedback:
    [Insert reviewer output]

    [Insert Decision Agent Prompt above]

    Make final deployment recommendation.
    """,
    subagent_type="Plan"
)
```

STEP 3: ACT ON DECISION
- If APPROVED: Proceed with deployment
- If REQUEST CHANGES: Fix issues, re-run review
- If DISCUSS: Engage human reviewer

6.5 AUTOMATION SCRIPT
----------------------

Create `.claude/hooks/pre-commit.sh`:
```bash
#!/bin/bash
# Pre-commit hook to run automated code review

echo "Running automated code review..."

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# Run reviewer agent via Claude Code
claude -p "Review these changed files for issues: $CHANGED_FILES" \
    --output review.json

# Check if any CRITICAL or HIGH issues
if grep -q '"severity": "CRITICAL"' review.json; then
    echo "BLOCKED: Critical issues found. See review.json"
    exit 1
fi

if grep -q '"severity": "HIGH"' review.json; then
    echo "WARNING: High severity issues found. Review before committing."
    read -p "Continue anyway? (y/n) " -n 1 -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "Code review passed."
exit 0
```

================================================================================
7. FILES MODIFIED SUMMARY
================================================================================

| File | Type | Lines Changed | Description |
|------|------|---------------|-------------|
| data.json | Data | +35 | Added holdingsKeywords to tokenConfig |
| scraper/website_scrapers.py | Python | +180 | New scrapers, field renames, regex fixes |
| js/services/api.js | JS | +130 | Stock price API, MTPLF fix, cache improvements |
| js/services/csv.js | JS | +25 | Selective export, parseInt fix, error logging |
| js/services/metrics.js | JS | +30 | Enhanced mNAV calculation |
| js/views/company.js | JS | +120 | Row selection, pre-fill enhancement |
| js/views/holdings.js | JS | +6 | Zero price handling |
| js/components/metrics-flashcard.js | JS | +8 | Ternary refactor |
| css/styles.css | CSS | +25 | Selection styling |

TOTAL: ~560 lines of new/modified code

================================================================================
8. VERIFICATION CHECKLIST
================================================================================

Before deploying, verify:

[ ] All Python tests pass: `python3 -m pytest tests/ -v`
[ ] data.json is valid JSON: `python3 -c "import json; json.load(open('data.json'))"`
[ ] No console.log debugging left in code
[ ] No hardcoded API keys or secrets
[ ] New scrapers handle network errors gracefully
[ ] Stock price cache uses per-ticker timestamps
[ ] MTPLF price displays in USD, not JPY
[ ] Treasury row selection works (select, deselect, select all)
[ ] Copy for IDE copies selected rows when rows are selected
[ ] Copy for IDE copies all rows when no rows are selected
[ ] Update banner pre-fills form correctly
[ ] mNAV calculations are reasonable (0 < mNAV < 100)

================================================================================
                              END OF DOCUMENTATION
================================================================================
